<!-- -*- indent-tabs-mode: nil -*- -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="language" content="en" />

  <title>OVIS Job Viewer</title>

  <link rel="stylesheet" type="text/css" href="css/jobbrowser.css" />
  <!--[if lte IE 7]>
      <style type="text/css"> body { font-size: 85%; } </style>
  <![endif]-->

  <link href="css/jquery.dthms_picker.css" rel="stylesheet" type="text/css" />
  <link href="css/jquery.dataTables.css" rel="stylesheet" type="text/css" />
  <script src="js/jquery-1.11.1/jquery.js" type="text/javascript"></script>
  <script src="js/jquery-ui-1.11.2/jquery-ui.min.js" type="text/javascript"></script>
  <script src="js/jquery.dthms_picker.js" type="text/javascript"></script>
  <script src="js/jquery.dataTables.js" type="text/javascript"></script>
  <link href="//code.jquery.com/ui/1.11.2/themes/smoothness/jquery-ui.css" rel="stylesheet" type="text/css" />

<script type="text/javascript">

function formatDate(aDate) {
    var str = aDate.getFullYear();
    var year = aDate.getFullYear(),
    mon = aDate.getMonth() + 1,
    day = aDate.getDate(),
    hour = aDate.getHours(),
    minute = aDate.getMinutes(),
    second = aDate.getSeconds();

    str = year;
    if (mon < 10)
        str += '/0' + mon;
    else
        str += '/' + mon;

    if (day < 10)
        str += '/0' + day;
    else
        str += '/' + day;

    str += ' ';

    if (hour < 10)
        str += '0' + hour;
    else
        str += hour;

    if (minute < 10)
        str += ':0' + minute;
    else
        str += ':' + minute;

    return str;
}

function timestr_to_timestamp(timestr) {
    var dt = timestr.split(' ');
    var aDate = dt[0].split('/');
    var aTime = dt[1].split(':');
    var msecs = new Date(aDate[0], aDate[1]-1, aDate[2],
                         aTime[0], aTime[1], aTime[2]);
    return msecs / 1000;
}

var graph_job_id, graph_name, graph_user_name, graph_start, graph_end;
function update_jobs(container) {
    $("#jobTableDiv").empty();
    $("#jobTableDiv").append('<table id="jobTable" style="width: 100%" class="display"></table>');
    $("#jobTable").prepend("<thead></thead>");
    $("thead", "#jobTable").append("<tr></tr>");
    $("tr","#jobTable").append('<th title="Click on a job to add a plot">Name</th>');
    $("tr","#jobTable").append('<th title="Click on a job to add a plot">User</th>');
    $("tr","#jobTable").append('<th title="Click on a job to add a plot">Start</th>');
    $("tr","#jobTable").append('<th title="Click on a job to add a plot">End</th>');
    $("tr","#jobTable").append('<th title="Click on a job to add a plot">Id</th>');

    var dataSrc = "/SOS/table?container=" + encodeURIComponent(container)
        + "&schema=Job"
        + "&index=StartTime"
	+ "&where=StartTime:ge:" + tbl_start_time
	+ ",EndTime:le:" + tbl_end_time;

    var columns = [
        {
            sName    : 'Name',
            mDataProp : 'JobName',
            sWidth : '10em',
            bSortable : true,
        },
        {
            sName    : 'User',
            mDataProp : 'UserName',
            bSearchable : true,
            bSortable : true,
        },
        {
            sName    : 'Start',
            mDataProp : 'StartTime',
            sWidth : '10em',
            bSortable : true,
        },
        {
            sName    : 'End',
            mDataProp : 'EndTime',
            sWidth : '10em',
        },
        {
            sName    : 'Id',
            mDataProp : 'Id',
            sWidth   : '4em'
        },
    ];
    var columnDefs = [
    ];
    jobTable = $("#jobTable").dataTable({
        "sDom": '<"top">rt<"bottom"ip><"clear">',
        bAutoWidth : true,
        order : [ [ 0, 'asc' ] ],
        ordering : true,
        lengthChange : false,
        bFilter : true,
        processing : true,
        serverSide : true,
        sAjaxSource : dataSrc,
        sAjaxDataProp : "Job",
        scrollX : true,
        sScrollY : "25em",
        aoColumns : columns,
        aoColumnDefs : columnDefs
    });
    $("#jobTable tbody").delegate("tr", "click", function() {
        /* Only allow one row to be selected at a time. */
        if ($(this).hasClass('selected')) {
              $(this).removeClass('selected');
         } else {
              jobTable.$('tr.selected').removeClass('selected');
              $(this).addClass('selected');
        }
    });
}

var tbl_start_time;
var tbl_end_time;

function update_container(container_el) {
    var cname = $("#containers").val();
    $.ajax({
        url: "/SOS/schema",
        data: "container="+cname+"&schema=Sample",
        dataType: 'json',
        success: function (obj) {
            if ('error' in obj) {
                return alert("The container " + cname + " could not be opened.")
            }
            var metricData = new Array();
            /* Add all the attributes to the metricTable */
            for (var i = 0; i < obj.attrs.length; i++) {
                attr = obj.attrs[i];
                var metric = [ attr.name, attr.sos_type ];
                metricData[i] = metric;
                if (attr.name != "Time")
                    continue;
                /*
                 * SOS Timestamp is 32b (seconds) | 32b (microseconds)
                 */
                var aTime = parseInt(attr.min_key);
                /* Convert aTime to seconds */
                aTime = aTime / 1024 / 1024 / 1024 / 4;
                tbl_start_time = aTime;
                /* Convert aTime to milliseconds and construct a Date */
                aTime = aTime * 1000;
                var aDate = new Date(aTime);
                /* Initialize the start-time control */
                $('#job_start_time').datetimepicker({
                    mask: '9999/19/39 29:59',
                    timepicker : true,
                    hmspicker : false,
                    format : "Y/m/d H:i",
                    step : 30,
                    value : aDate,
                    onClose : function(time, el, event) {
			var cname = $("#containers").val();
                        tbl_start_time = Date.parse(el.val()) / 1000;
			update_jobs(cname);
                    },
                });
                var aDateStr = formatDate(aDate);
                $('#job_start_time').val(aDateStr);

                aTime = parseInt(attr.max_key);
                aTime = aTime / 1024 / 1024 / 1024 / 4;
                tbl_end_time = aTime;
                aDate = new Date(aTime * 1000);
                $('#job_end_time').datetimepicker({
                    mask: '9999/19/39 29:59',
                    timepicker : true,
                    hmspicker : false,
                    format : "Y/m/d H:i",
                    step : 30,
                    value : aDate,
                    onClose : function(time, el, event) {
			var cname = $("#containers").val();
                        tbl_end_time = Date.parse(el.val()) / 1000;
			update_jobs(cname);
                    },
                });
                aDateStr = formatDate(aDate);
                $('#job_end_time').val(aDateStr);
                update_jobs(cname);
            }
            metricTable.fnClearTable(false);
            metricTable.fnAddData(metricData, true);
            $("#metricTable tbody").delegate("tr", "click", function() {
                /* Only allow one row to be selected at a time. */
                if ($(this).hasClass('selected')) {
                    $(this).removeClass('selected');
                } else {
                    metricTable.$('tr.selected').removeClass('selected');
                    $(this).addClass('selected');
                }
            });
        },
        error: function (xhr, desc, er) {
            alert(xhr.responseText);
        }
    });
}

var userTable, jobTable, metricTable;

$(document).ready( function() {
    $.ajax({
        url: "/SOS/directory",
        dataType: 'json',
        success: function (obj) {
            var i, o;
            $("#containers option").remove();
            for (i = 0; i < obj.directory.length; i++) {
                o = document.createElement("OPTION");
                o.value = obj.directory[i]['name'];
                o.text = obj.directory[i]['name'];
                o.obj = obj;
                $("#containers").append($(o).clone());
            }
            var idxOpts = $("#containers option");
            idxOpts.sort(function(a,b) {
                if (a.label < b.label)
                    return -1;
                else if (a.label == b.label)
                    return 0;
                return 1;
            });
            $("#containers").empty().append(idxOpts);
            if ($("#containers").length > 0) {
                $("#containers option:first-child").attr("selected","selected");
                update_container();
            }
        }
    });

    $( document ).tooltip({
        position: {
            my: "center bottom-20",
            at: "center top",
            using: function( position, feedback ) {
                $( this ).css( position );
                $( "<div>" )
                    .addClass( "arrow" )
                    .addClass( feedback.vertical )
                    .addClass( feedback.horizontal )
                    .appendTo( this );
            }
        }
    });
    var aaData = new Array();
    metricTable = $("#metricTable").dataTable({
        "sDom": '<"top"f>rt<"bottom"l><"clear">',
        paging : false,
        bAutoWidth : true,
        order : [ [ 0, 'asc' ] ],
        ordering : true,
        lengthChange: false,
        sScrollY : "25em",
        processing : true,
        aaData : aaData,
        aoColumns: [
            { sTitle : "Name", bSortable : true },
            { sTitle : "Type", bSortable : false }
        ],
    }).on('draw.dt', function() {
    });
});

function add_graph() {
    if (jobTable.$('.selected').length == 0) {
        alert("A Job must be selected.");
        return;
    }
    if (metricTable.$('.selected').length == 0) {
        alert("A Metric must be selected.");
        return;
    }
    var jobRow = jobTable.$('.selected')[0];
    var jobRowData  = jobTable.DataTable().row(jobRow).data();
    var graph_start = timestr_to_timestamp(jobRowData.StartTime);
    var graph_end = timestr_to_timestamp(jobRowData.EndTime);
    var job_id = parseInt(jobRowData.Id);
    var metricRow = metricTable.$('.selected')[0];
    var metricRowData =  metricTable.DataTable().row(metricRow).data();
    var metric_name = metricRowData[0];

    /* Add a new graph */
    var duration = 3600;
    var url = "/SOS/metric_graph?container="
        + encodeURIComponent($("#containers").val())
        + "&job_id=" + job_id
        + "&metric_name=" + encodeURIComponent(metric_name)
        + "&start=" + graph_start
        + "&end=" + graph_end;
    window.open(url, "Binkus", "width=850px, height=320px, modal=yes");
}

</script>

</head>
<body>

  <div class="header">Job Selector</div>
  <div class="content">
    <div style="margin-top: .5em">
      <div style="float:left;">
        <label for="containers"
               class="block_label" title="Select the container">Container
        </label>
        <select name="containers" style="width: 14em"
                onchange="update_container()" id="containers"></select>
      </div>
      <div style="float:left; margin-left:.5em;">
        <label for="job_start_time" class="block_label"
               title="Select the job start time">Jobs starting after
        </label>
        <input type="text" id="job_start_time"/>
      </div>
      <div style="float:left; margin-left:.5em;">
        <label for="job_end_time" class="block_label"
               title="Select the Job end time">and ending before
        </label>
        <input type="text" id="job_end_time"/>
      </div>
    </div>
    <br style="clear:both"/>
    <div id="jobTableDiv" style="float: left; margin-top: 1em; width: 75%;">
      <table id="jobTable" class="display"></table>
    </div>
    <div style="float: left; margin-top: 1em; width: 25%;">
      <table id="metricTable" class="display">
        <thead>
          <tr>
            <th title="Click on a row to include a metric in the plot">Name</th>
            <th title="Click on a row to include a metric in the plot">Type</th>
          </tr>
        </thead>
      </table>
    </div>
    <br style="clear: both"/>
    <div style="margin-top: 1em;">
      <button type="button" onclick="add_graph()">Add Graph</button>
    </div>
  </div>
</body>
</html>
