<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
          "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<style type="text/css">
.custom-date-style {
    background-color: red !important;
}
label {
    display: block;
}
select {
    width: 8em;
}
.ui-tooltip, .arrow:after {
    background: black;
    border: 2px solid white;
}
.ui-tooltip {
    padding: 10px 20px;
    color: white;
    border-radius: 20px;
    font: 14px "Helvetica Neue", Sans-Serif;
    box-shadow: 0 0 7px black;
}
.arrow {
    width: 70px;
    height: 16px;
    overflow: hidden;
    position: absolute;
    left: 50%;
    margin-left: -35px;
    bottom: -16px;
}
.arrow.top {
    top: -16px;
    bottom: auto;
}
.arrow.left {
    left: 20%;
}
.arrow:after {
    content: "";
    position: absolute;
    left: 20px;
    top: -20px;
    width: 25px;
    height: 25px;
    box-shadow: 6px 5px 9px -9px black;
    -webkit-transform: rotate(45deg);
    -ms-transform: rotate(45deg);
    transform: rotate(45deg);
}
.arrow.top:after {
    bottom: -20px;
    top: auto;
}
</style>
<title>Scalable Object Store Browser</title>
<!--
<div id="banner">
  <div style="float:left"><img src="images/OGC-LOGO-SQUARE.png" height="64" width="64"/></div>
  <div style="float:left; vertical-align:middle; text-align:center; font-size:200%">Scalable Object Store Browser</div>
  <div style="float:right"><img src="images/OGC-LOGO-SQUARE.png" height="64" width="64"/></div>
</div>
<br style="clear:both"/>
-->
<link href="//code.jquery.com/ui/1.11.2/themes/smoothness/jquery-ui.css" rel="stylesheet" type="text/css" />
<link href="css/jquery.dthms_picker.css" rel="stylesheet" type="text/css" />
<link href="css/jquery.dataTables.css" rel="stylesheet" type="text/css" />
<link href="css/Multi-Column-Select.css" rel="stylesheet" type="text/css" />
<script src="js/jquery-1.11.1/jquery.js" type="text/javascript"></script>
<script src="js/jquery-ui-1.11.2/jquery-ui.min.js" type="text/javascript"></script>
<script src="js/jquery.dthms_picker.js" type="text/javascript"></script>
<script src="js/jquery.dataTables.js" type="text/javascript"></script>
<script src="js/jquery.jeditable.js" type="text/javascript" type="text/javascript"></script>
<script src="js/jquery.jeditable.checkbox.js" type="text/javascript" type="text/javascript"></script>
<script src="js/jquery-validate.js" type="text/javascript"></script>
<script src="js/Multi-Column-Select.js" type="text/javascript"></script>
<script type="text/javascript">

var filterTable;

function update_schemas(container_el) {
    var cname = $("#containers").val()
    $("#sostablediv").empty();
    $.ajax({
        url: "/SOS/container",
        data: "container="+cname,
        dataType: 'json',
        success: function (obj) {
            if ('error' in obj) {
                return alert("The container " + cname + " could not be opened.")
            }
            var i, o;
            $("#schema").selectmenu("destroy");
            $("#schema option").remove();
            for (i = 0; i < obj.schemas.length; i++) {
                o = document.createElement("OPTION");
                o.value = obj.schemas[i]['schema_name'];
                o.text = obj.schemas[i]['schema_name'];
                $("#schema").append(o);
            }
            $("#schema").selectmenu({ change : select_schema }).selectmenu("option", "width", "12em");
            if ($("#schema option").length > 0) {
                $("#schema option:first-child").attr("selected","selected");
                select_schema();
            }
        },
        error: function (xhr, desc, er) {
            alert(xhr.responseText);
        }
    });
}

function select_schema() {
    var cname = $("#containers").val();
    var schema_name = $("#schema").val();
    $.ajax({
        url: "/SOS/schema",
        data: "container="+cname+'&'+'schema='+schema_name,
        dataType: 'json',
        success: function (obj) {
            var i, o;
            $("#iter_index").selectmenu("destroy");
            $("#iter_index option").remove();
            for (i = 0; i < obj.attrs.length; i++) {
                if (obj.attrs[i]['indexed'] == "True") {
                    o = document.createElement("OPTION");
                    o.value = obj.attrs[i]['name'];
                    o.text = obj.attrs[i]['name'];
                    $("#iter_index").append(o);
                }
            }
            var idxOpts = $("#iter_index option");
            idxOpts.sort(function(a,b) {
                if (a.label < b.label)
                    return -1;
                else if (a.label == b.label)
                    return 0;
                return 1;
            });
            $("#iter_index").empty().append(idxOpts);
            if ($("#iter_index option").length > 0) {
                $("#iter_index option:first-child").attr("selected","true");
            }
            $("#iter_index").selectmenu().selectmenu("option", "width", "12em");

            $("#x_axis").selectmenu("destroy");
            $("#x_axis option").remove();
            var o;
            var aaData = Array();
            for (i = 0; i < obj.attrs.length; i++) {
                aaData[i] = [ false, obj.attrs[i]['name'], obj.attrs[i]['sos_type'],
                              false, ">=", "", "<=", "" ];
                o = document.createElement("OPTION");
                o.value = obj.attrs[i]['name'];
                o.text = obj.attrs[i]['name'];
                $("#x_axis").append(o);
            }
            $("#x_axis").selectmenu().selectmenu("option", "width", "12em");
            var xOpts = $("#x_axis option");
            xOpts.sort(function(a,b) {
                if (a.label < b.label)
                    return -1;
                else if (a.label == b.label)
                    return 0;
                return 1;
            });
            $("#x_axis").empty().append(xOpts);

            filterTable.fnClearTable(false);
            filterTable.fnAddData(aaData, true);

            $('input[name="TIMESTAMP"]').datetimepicker({
                // mask:'9999/19/39 29:59',
                "timepicker" : false,
                "hmspicker" : true,
                "format" : "Y/m/d H:i:s",
                "step" : 1
            });
            $("#selectall")[0].checked = true;
            select_all($("#selectall")[0]);
        },
        error: function (xhr, desc, er) {
            alert(er);
        }
    });
}

function cbox_chg(el) {
    var id = el.id;
    var a = id.split('_');
    var row = parseInt(a[1]);
    var col = parseInt(a[2]);
}

function select_all(el) {
    var ftbl = $("#filtertable").DataTable();
    ftbl.rows(function(idx, data, node) {
        var cols = $('input:checkbox', node);
        cols[0].checked = el.checked;
    });
}

$(document).ready(function() {
    $("#schema").selectmenu();
    $("#x_axis").selectmenu();
    $("#show_results").button().click(function( event ) {
        show_results();
    });
    $("#radios").buttonset();
    $("#iter_index").selectmenu();
    $("#unique_index").button();
    $.ajax({
        url: "/SOS/directory",
        dataType: 'json',
        success: function (obj) {
            var i, o;
            $("#containers option").remove();
            for (i = 0; i < obj.directory.length; i++) {
                o = document.createElement("OPTION");
                o.value = obj.directory[i]['name'];
                o.text = obj.directory[i]['name'];
                o.obj = obj;
                $("#containers").append($(o).clone());
            }
            var idxOpts = $("#containers option");
            idxOpts.sort(function(a,b) {
                if (a.label < b.label)
                    return -1;
                else if (a.label == b.label)
                    return 0;
                return 1;
            });
            $("#containers").empty().append(idxOpts);
            $("#containers").selectmenu({ change : update_schemas });
            $("#containers").selectmenu("option", "width", "12em");
            if ($("#containers").length > 0) {
                $("#containers option:first-child").attr("selected","selected");
                update_schemas();
            }
        }
    });

    var aaData = new Array();
    filterTable = $("#filtertable").dataTable({
        // "bJQueryUI" : true,
        // "bPaginate" : true,
        "aLengthMenu" : [ 5, 10, 15 ],
        "sScrollY" : "14em",
        "bProcessing" : true,
        // "bFilter" : false,
        "aaData" : aaData,
        "aoColumns": [
            { "sTitle" : "<label for='selectall'>Show</label><input type='checkbox' id='selectall' onclick='select_all(this)'></input>", "bSortable" : false },
            { "sTitle" : "Attribute", "bSortable" : true },
            { "sTitle" : "Type", "bSortable" : false },
            { "sTitle" : "Filter", "bSortable" : false },
            { "sTitle" : "CondA", "bSortable" : false },
            { "sTitle" : "ValueA", "bSortable" : false },
            { "sTitle" : "CondB", "bSortable" : false },
            { "sTitle" : "ValueB", "bSortable" : false }
        ],
        "aoColumnDefs" : [
            { "aTargets" : [0],
              "mData" : function(rowData, type, val) {
                  if (type == 'set') {
                      if (val)
                          rowData[0] = true;
                      else
                          rowData[0] = false;
                  } else
                      return rowData[0];
              },
              "mRender": function (colData, type, rowData, meta) {
                  if (type == "type")
                      return "html";
                  else {
                      var s = '<input id="fcol_' + meta.row + '_' + meta.col
                          + '" type="checkbox" onchange="cbox_chg(this)" row="'+meta.row+'" ';
                      if (colData)
                          return s + 'checked value="true">';
                      else
                          return s + 'value="false">';
                  }
              }
            },
            { "aTargets" : [3],
              "mRender": function (colData, type, rowData, meta) {
                  if (type == "type")
                      return "html";
                  else {
                      if (colData)
                          return '<input type="checkbox" checked value="true">';
                      else
                          return '<input type="checkbox" value="false">';
                  }
              }
            },
            { "aTargets" : [4],
              "mRender": function (colData, type, rowData, meta) {
                  if (type == "type")
                      return "html";
                  else {
                      s = '<select style="width:5em">'
                          + "<option value=':gt:'>> </option>"
                          + "<option value=':ge:'>>=</option>"
                          + "<option value=':eq:'>==</option>"
                          + "<option value=':le:'><=</option>"
                          + "<option value=':lt:'>< </option>"
                          + "</select>"
                      return s;
                  }
              }
            },
            { "aTargets" : [5],
              "mRender": function (colData, type, rowData, meta) {
                  if (type == "type")
                      return "html";
                  else
                      return '<input type="text" name="' + rowData[2] + '"/>';
              }
            },
            { "aTargets" : [6],
              "mRender": function (colData, type, rowData, meta) {
                  if (type == "type")
                      return "html";
                  else {
                      s = '<select style="width:5em">'
                          + "<option value=':gt:'>> </option>"
                          + "<option value=':ge:'>>=</option>"
                          + "<option value=':eq:'>==</option>"
                          + "<option value=':le:'><=</option>"
                          + "<option value=':lt:'>< </option>"
                          + "</select>"
                      return s;
                  }
              }
            },
            { "aTargets" : [7],
              "mRender": function (colData, type, rowData, meta) {
                  if (type == "type")
                      return "html";
                  else
                      return '<input type="text" name="' + rowData[2] + '"/>';
              }
            }
        ]
    }).on('draw.dt', function() {
        $('input[name="TIMESTAMP"]').datetimepicker({
            // mask:'9999/19/39 29:59',
            "timepicker" : false,
            "hmspicker" : true,
            "format" : "Y/m/d H:i:s",
            "step" : 1
        });
    });
    $( document ).tooltip({
        position: {
            my: "center bottom-20",
            at: "center top",
            using: function( position, feedback ) {
                $( this ).css( position );
                $( "<div>" )
                    .addClass( "arrow" )
                    .addClass( feedback.vertical )
                    .addClass( feedback.horizontal )
                    .appendTo( this );
            }
        }
    });
});

function show_table(containerName, schemaName, indexName, unique, viewCols, filters) {
    $("#sostablediv").append('<table id="sostable" class="display"></table>');
    $("#sostable").prepend("<thead></thead>");
    $("thead", "#sostable").append("<tr></tr>");

    // Build the select clause
    var colNames = viewCols.join(',');
    var columns = new Array();
    for (i = 0; i < viewCols.length; i++) {
        var name = viewCols[i];
        var col = {
            bSortable : false,
            mDataProp : name,
            sName : name,
            mData : function (data, type, row, meta) {
                return data[meta.settings.aoColumns[meta.col].mDataProp];
            }
        };
        columns[i] = col;
        $("tr","#sostable").append("<th>"+viewCols[i]+"</th>");
    }
    var dataSrc = "/SOS/table?container=" + encodeURIComponent(containerName)
        + "&schema=" + encodeURIComponent(schemaName)
        + "&index=" + encodeURIComponent(indexName);
    if (unique)
	dataSrc += "&unique";
    if ($("#selectall")[0].checked == false)
        dataSrc += "&select=" + encodeURIComponent(colNames);
    if (filters.length > 0)
        dataSrc += "&where=" + encodeURIComponent(filters.join(','));
    $("#sostable").dataTable({
        /*
        "ajax" : {
            "url" : dataSrc,
            "dataSrc" : schemaName
        },
        */
        bSort : false,
        bFilter : false,
        processing : true,
        serverSide : true,
        sAjaxSource : dataSrc,
        sAjaxDataProp : schemaName,
        scrollX : true,
        sScrollY : "22em",
        aoColumns : columns,
    });
    /*
    $("#sostable").dataTable().on('xhr.dt', function(e, settings, json) {
        alert("ooahh");
    });
    */
}

function show_graph(containerName, schemaName, indexName, unique, viewCols, filters) {

    $("#sostablediv").append('<div id="graph_head"></div>');
    $("#graph_head").append('<label for="sample_count">Sample Count</label>');
    $("#graph_head").append('<input id="sample_count" type="text" style="width:10em"/>');

    $("#sostablediv").append('<div id="graph_body"></div>');

    $("#sostablediv").append('<div id="graph_foot"></div>');
    $("#graph_foot").append('<div style="text-align:left;float:left; width:20%"><input id="prev_graph" type="submit" value="Previous"/></div>');
    $("#graph_foot").append('<div style="text-align:center;float:left;width:60%"><input id="save_graph" type="submit" value="Save"/></div>');
    $("#graph_foot").append('<div style="text-align:right;float:left;width:20%"><input id="next_graph" type="submit" value="Next"/></div>');
    $("#prev_graph").button().click(function( event ) {
        alert();
    });
    $("#save_graph").button().click(function( event ) {
        alert();
    });
    $("#next_graph").button().click(function( event ) {
        alert();
    });

    var url = "/SOS/graph?container=" + encodeURIComponent(containerName)
        + "&schema=" + encodeURIComponent(schemaName)
        + "&index=" + encodeURIComponent(indexName)
        + "&start=0&count=100"
	+ "&x_axis=" + encodeURIComponent($("#x_axis").val());
    if (viewCols.length > 0)
        url += "&select=" + encodeURIComponent(viewCols.join(','));
    if (filters.length > 0)
        url += "&where=" + encodeURIComponent(filters.join(','));
    $("#graph_body").append('<img id="graph_image" src="'+url+'"/>');
}

function show_results() {
    var containerName = $("#containers").val();
    var schemaName = $("#schema").val();
    var viewCols = Array();
    var filters = Array();
    var indexName = $("#iter_index").val();
    var filterTable = $("#filtertable").DataTable();

    viewCols.push(indexName);
    filterTable.rows(function(idx, data, node) {
        var cols = $('input:checkbox', node);
        if (cols[0].checked) {
            if (data[1] != indexName)
                viewCols.push(data[1])
        }
        if (cols[1].checked) {
            var conds = $('select', node);
            var vals = $('input:text', node);
            /* Filter condition */
            var condA = $(conds[0]).val();
            var condB = $(conds[1]).val();
            var valA = $(vals[0]).val();
            var valB = $(vals[1]).val();
            var filterA = data[1] + condA + '"' + valA + '"';
            var filterB = data[1] + condB + '"' + valB + '"';
            if (valA.length > 0) {
                filters.push(filterA);
            }
            if (valB.length > 0) {
                filters.push(filterB);
            }
        }
    });
    if (viewCols.length == 0) {
        alert("At least one attribute must be selected.");
        return;
    }
    var unique = $("#unique_index").is(":checked")
    var view = $('input[name="radios"]:checked').val();
    $("#sostablediv").empty();
    if (view == "table")
        show_table(containerName, schemaName, indexName, unique, viewCols, filters);
    else
        show_graph(containerName, schemaName, indexName, unique, viewCols, filters);
}

</script>
</head>
<body>
  <div>
    <div style="float:left">
      <div style="float:left; margin-left:.5em; margin-right:.5em">
        <label for="containers" title="Select the container">Container</label>
        <select name="containers" id="containers"></select>
      </div>
      <div style="float:left; margin-left:.5em; margin-right:.5em">
        <label for="schema" title="Select the schema from the container">Schema</label>
        <select name="schema" id="schema"></select>
      </div>
      <div style="float:left; margin-left:.5em; margin-right:.5em">
        <label for="iter_index" title="Select which attribute will be used to order data. If the result is a graph, this is the X-axis">Index</label>
        <select name="index" id="iter_index"></select>
      </div>
      <div style="float:left; margin-left:.5em; margin-right:.5em; margin-top:1.1em">
        <label for="unique_index" title="Show only unique values from the index.">Unique</label>
        <input type="checkbox" name="unique_index" id="unique_index"/>
      </div>
      <div style="float:left; margin-left:.5em; margin-right:.5em">
        <label for="x_axis" title="Select the attribute to use for the X-axis on graphs">X-axis</label>
        <select name="x_axis" id="x_axis"></select>
      </div>
      <br style="clear:both"/>
    </div>
    <br style="clear:both"/>
    <div id="filterdiv" style="float:left; margin-left:1em; margin-right:1em; margin-top:1em">
      <table id="filtertable" class="display">
        <thead>
          <tr>
            <th title="Click the checkbox to show the attribute in the results. If the result is a table, each attribute is a column, if the result is a graph, each attribute is a time-series.">Show</th>
            <th title="The name of the attribute.">Attribute</th>
            <th title="The type of the attribute.">Type</th>
            <th title="Click the checkbox to enable filtering on the attribute.">Filter</th>
            <th title="The first condition for the attribute.">CondA</th>
            <th title="The value to compare with the attribute. It will be ignored if the value is not set">ValueA</th>
            <th title="The first condition for the attribute.">CondB</th>
            <th title="The value to compare with the attribute. It will be ignored if the value is not set">ValueB</th>
          </tr>
        </thead>
      </table>
    </div>
  </div>
  <br style="clear:both"/>
  <div>
    <div style="float:left; margin-left:5em; margin-right:1em">
      <input id="show_results" type="submit" value="Show Results"/>
    </div>
    <div id="radios">
      <label for="show_table">Table</label>
      <input type="radio" id="show_table" name="radios" value="table" checked/>
      <label for="show_graph">Graph</label>
      <input type="radio" id="show_graph" name="radios" value="graph"/>
    </div>
  </div>
  <br style="clear:both"/>
  <div id="sostablediv"></div>
</body>
</html>
